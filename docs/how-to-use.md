# 本ツールの詳細な使い方

## 作業用 Google Drive フォルダの作成

大会運営用Googleアカウントにログインした状態で、[Google Drive](https://drive.google.com/)を開き、大会の作業用フォルダを作成します。
このフォルダは、共有を行わないか、運営のために必要最小限の人のみを個別に共有設定して下さい。

さらに、この作業用フォルダの下に、ジャッジやスタッフ等が閲覧・編集する投票・採点シート等を保存するためのサブフォルダを作成します。
フォルダ名はわかりやすいものであれば何でも構いません。
また、このフォルダには「リンクを知っている全員」に「編集者」の共有設定を行い、さらに、[Google アカウントの設定](https://www.google.com/intl/ja/account/about/)の手順で作成した「サービスアカウントID」を「編集者」として共有設定して下さい。

## 対戦スケジュール表の作成

試合会場用Zoomミーティングや投票・採点用シートの自動作成の基となる情報を管理する「対戦スケジュール表」を作成します。

* [対戦スケジュール表の雛形](https://docs.google.com/spreadsheets/d/1q1af5QatqQAkq1RtBX8MLg4Jy1qaB1pBe5SHJMzgWT4/edit?usp=sharing)を開き、メニューの「ファイル」→「コピーを作成」を選択します。
  * 「名前」は、「～のコピー」を除去し、さらに大会名等を付加するなどして分かりやすいものに変えて下さい。
  * 「フォルダ」は先ほど作成した大会の作業用フォルダを選択します。
* コピーされた対戦スケジュール表が開きますので、画面右上の「共有」ボタンをクリックして、[Google アカウントの設定](https://www.google.com/intl/ja/account/about/)の手順で作成した「サービスアカウントID」を「編集者」として共有設定して下さい。
  これにより、本ツールがこのスプレッドシートの情報を読み取り、自動処理した結果を記入することができるようになります。
* 「チーム一覧」のシートを選んで、実際の参加チームを記入して下さい。
  * 行を追加する場合には、末尾ではなく中ほどに追加し、「No.」欄を後から修正して下さい。
    そうしないと「対戦表」のシートで参照しているセルの範囲が崩れて正しく表示できません。
  * C列以降の情報は特にプログラムで使用しておりませんので、運営に必要な情報の列を適宜追加して構いません。
* 「ジャッジ一覧」のシートを選んで、実際の審判名を記入して下さい。
  * 行を追加する場合には、末尾ではなく中ほどに追加し、「No.」欄を後から修正して下さい。
    そうしないと「対戦表」のシートで参照しているセルの範囲が崩れて正しく表示できません。
  * C列以降の情報は特にプログラムで使用しておりませんので、運営に必要な情報の列を適宜追加して構いません。
* 「対戦表」のシートを選んで、試合の情報を入力していきます。
  * 大会の1日の総試合数合わせて行の追加または削除を行います。
    (2日以上に渡る大会の場合は、シートをさらにコピーして1日分ずつ作成して下さい。)
    罫線は特に動作に影響しないので、見やすいように適宜変更して下さい。
  * 大会の審判数に合わせてG～I列の修正を行います。
    * 1人ジャッジの場合には、H～I列を削除して下さい。
    * 5人やそれ以上の数のジャッジの場合には、I列を選択して右クリック、「1列を右に挿入」を必要分行って下さい。
  * 大会の開催日(B1セル)を実際の日程に合わせて変更して下さい。
  * 「試合No.」「会場」「開始」「終了」を実際の内容に合わせて変更して下さい。
    「試合No.」「会場」の形式は、特にサンプルで使っているものに限りませんので、よりわかりやすいものに変えても構いません。
    * 例) 「試合No.」を「予選Aグループ1」や「準々決勝A」等にしても良いということです。
  * 「肯定側」「否定側」「審判」の欄を、実際の大会の内容に合わせて記入して下さい。
    「チーム一覧」「ジャッジ一覧」が正しく作成できていれば、ドロップダウンリストで選択して入力できます。
* 同じく「対戦表」のシート内で、Zoomアカウントの割り付けを行います。
  * 「メールアドレス」「パスワード」の欄に、[Zoom ユーザーの作成](docs/zoom-create-user.md) の手順で作成した内容を記入します。
    * 時間が重複する設定の試合にはそれぞれ1つのユーザーを割り当てる必要があります。
      例えば 10:00～11:30と10:30～12:00というように、全く同じ時間帯でなくても、重複している部分があれば別のユーザーを用いなければなりません。
      万が一、同じユーザーで試合の時間が重複していると、後の試合が立ち上げられた時点で前の試合が強制終了されてしまいます。
  * 「会場URL」「ミーティングID」「パスコード」の欄は、本ツールによりZoomのミーティングが作成された後に、自動的に記入されますので、空欄のままにして下さい。
    もし、何か記入されている場合は削除して下さい。

## 設定ファイルの編集

本ツールを動作させるのに必要な設定ファイルに、ここまでの手順で作成してきた情報を記入します。

* 本ツールをPCに展開したフォルダを開き、[zoom-key.yaml.sample](/zoom-key.yaml.sample) を同フォルダ内に `zoom-key.yaml` という名前でコピーします。
* テキストエディタで `zoom-key.yaml` を開き、`api-key` と `api-secret` に [Zoom API の設定](docs/zoom-api.md) 手順で控えておいた「API Key」と「API Secret」をそれぞれ記入します。
* 本ツールをPCに展開したフォルダを開き、[config-dkoshien.yaml.sample](/config-dkoshien.yaml.sample) または [config-jda.yaml.sample](/config-jda.yaml.sample) を同フォルダ内に別名でコピーします。
  * 前者はディベート甲子園フォーマットの「[勝敗・コミュニケーション点記入シート](https://docs.google.com/spreadsheets/d/1hiba7wnR3u0dffsJmQTKSC-usT2_84OAk-xZ4VHhAYg/edit?usp=sharing)」を使用し
    後者はJDA大会フォーマットの「[バロット・ポイントシート](https://docs.google.com/spreadsheets/d/1Z6aCHLEy2ZXB-dlipBhBCyHh2D6sC7UNrEo1LCUIEm8/edit?usp=sharing)」を使用します。
    大会の形式に合わせていずれかを選んで下さい。
    なお、これらの設定ファイルを改造すれば、独自の書式も使用できます。(詳細は後述)
  * ファイルの命名規則は特にありませんが、大会名等に基づくわかりやすいものにし、拡張子は `.yaml` に直して下さい。
    例) `config-dkoshien2021-practice.yaml`
* テキストエディタで作成した設定ファイルを開き必要な事項を記入します。
  * `auth` の下の `key_file` の所を、[Google API の設定](docs/google-api.md) の手順で作成した「鍵ファイル (`xxx.json`)」の保存先に書き換えます。
  * `file_id` の所を、前の手順で作成した対戦スケジュール表の ID に書き換えます。
    * ID とはスプレッドシートを開いた時の URL (`https://docs.google.com/spreadsheets/d/xxxxx/edit?usp=sharing`) の xxxxx の部分の文字列です。
* `prefix` を大会名に書き換えます。
  ここの内容は、自動作成される Zoom ミーティングのタイトルに使われます。
  雛形では末尾に半角スペースがついていますが、そのまま付けておいて下さい。
* `ballot` の下にある `title` を、投票・採点シートのタイトルに指定する文字列に書き換えます。
* `ballot` の下にある `folder` を、投票・採点シートのタイトルに指定する文字列に書き換えます。

## 試合会場の生成

ここまで作成してきた対戦スケジュール表と設定ファイルを元に、 Zoom ミーティングを自動生成します。

* コマンドプロンプトを開き、本ツールを展開したフォルダに移動します。
* 以下のコマンドを実行して、試合会場を作成します。
  (設定ファイル名 (`*.yaml`) の部分は自身が作成したファイル名に適宜置き換えて下さい。)

  ```console
  uv run manage.py -c config-dkoshien2021-practice.yaml generate-room
  ```

* しばらく待って `Complete.` と表示されれば成功です。
  * 対戦スケジュール表を開くと、「会場URL」「ミーティングID」「パスコード」の欄が埋まっているはずです。
  * 割り付けた Zoom ユーザー (メインの Zoom アカウントではなく連番で作った方) で [Zoom](https://zoom.us/signin) にサインインしてみて、ミーティングがスケジュールされていることを確認して下さい。

## 投票・採点記入用シートの生成

ここまで作成してきた対戦スケジュール表と設定ファイルを元に、 投票・採点記入用シートを自動生成します。

* コマンドプロンプトを開き、本ツールを展開したフォルダに移動します。
* 以下のコマンドを実行して、試合会場を作成します。
  (設定ファイル名 (`*.yaml`) の部分は自身が作成したファイル名に適宜置き換えて下さい。)

  ```console
  uv run manage.py -c config-dkoshien2021-practice.yaml generate-ballot
  ```

* しばらく待って `Complete.` と表示されれば成功です。
  * 対戦スケジュール表を開くと、ジャッジの名前にハイパーリンクが付いているはずです。
    このリンクをクリックすると、それぞれの審判がその試合で用いる投票・採点記入用シートが開きます。
  * リンクが付いていない場合には、対戦スケジュール表のジャッジ名の範囲をマウスで選択し、右クリックして「リンクに変換」を選択するとリンクが付くようになります。

## 集計機能の確認

ここまでの手順で作成した投票・採点記入用シートに記入された内容は、対戦スケジュール表に集計されるように関連付けが行われています。
その集計結果を正しく参照するために、以下の手順を行います。

* 対戦スケジュール表を開き、「投票」のシートを選んで下さい。
  * 試合数×ジャッジ数分の行が自動的に作成されていることを確認して下さい。
  * いずれかの投票・採点記入用シートを開き、採点や勝敗を記入してみて、このシートに値が反映されることを確認して下さい。
* 「勝敗」のシートを選んで下さい。
  * 行数を対戦表と同じになるよう、挿入/削除し、追加した行の部分には元々あった行の数式をコピーします。
  * 「No.」の列は、「対戦表」のシートで設定したものと同じになるように修正します。
  * 「投票」シートに反映された各ジャッジの投票・採点が試合毎に集計されることを確認して下さい。
* 「集計」のシートを選んで下さい。
  * 行数をチーム一覧と同じになるよう、挿入/削除し、追加した行の部分には元々あった行の数式をコピーします。
  * 「チーム名」の列は、「チーム一覧」のシートで設定したものと同じになるように修正します。

## 独自形式の投票・採点記入用シートの利用 (Advanced Usage)

サンプルとして用意されている、ディベート甲子園用とJDA大会用以外に、独自に作成した投票・採点記入用シートの雛形を利用したい場合は、以下の手順で利用できます。

* 雛形となるスプレッドシートを用意し、「リンクを知っている全員」に「閲覧者」の共有設定を行います。
* [config-dkoshien.yaml.sample](/config-dkoshien.yaml.sample) を別名でコピーし、拡張子を `.yaml` に直します。
* 設定ファイルをテキストエディタで開き、以下の点を修正します。
  * `ballot` の下の `template` を用意した雛形のIDに書き換えます。
    * ID とはスプレッドシートを開いた時の URL (`https://docs.google.com/spreadsheets/d/xxxxx/edit?usp=sharing`) の xxxxx の部分の文字列です。
  * `ballot` の下の `to_vote` の内容を書き換えます。
    これは、投票・採点記入用シートのどのセルの内容を、対戦スケジュール表の「投票」シートのどの列に反映させるかという定義リストです。
  * `ballot` の下の `to_ballot` の内容を書き換えます。
    これは、対戦スケジュール表の「対戦表」シートのどの列の内容を、投票・採点記入用シートどのセルに反映させるかという定義リストです。
    * `[0, "C4"]` は、0番目 = A列 = 試合No. をC4セルにコピーすることを示します。
    * `[[4,5], "E36"]` は、4番目と5番目 = E列とF列 = 肯定側と否定側 をドロップダウン選択として、E36セルに設定することを示します。
    * `[6, "H4", true]` は、6+n番目 (n=0,1,2…) = G,H,I,…列 = n番目のジャッジの名前を、それぞれ対応するジャッジ用の投票・採点記入用シートのH4セルにコピーすることを示します。
